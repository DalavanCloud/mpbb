#!/bin/bash

# Note:
# This script is sourced by the mpbb wrapper script.
# Do not execute this directly!


list-subports-help() {
    echo "Print the name of port --port and its subports."
    echo "Alternatively, print the name and subports of multiple ports given as positional arguments."
}

print-subports() {
    local portname=$1
    local port
    local portgroup
    local ports
    local exclude

    ports=$("${option_prefix}/bin/port" -q info --index --line --name "subportof:${portname}" "${portname}" 2>/dev/null) || return $?
    for port in $ports; do
        exclude=0
        for portgroup in $("${option_prefix}/bin/port-tclsh" "${thisdir}/tools/portgroups.tcl" "$port"); do
            if [ "$portgroup" = "obsolete-1.0" ]; then
                exclude=1
            fi
        done
        if [ $exclude -ne 1 ]; then
            echo "$port"
        fi
    done
}

list-subports() {
    if [ $# -le 0 -a -z "${option_port}" ]; then
        errmsg "Either --port or a list of positional arguments with port names is required."
        return 1
    fi

    success=0

    if [ -n "${option_port}" ]; then
        print-subports "${option_port}" && success=1
    fi

    for p in "$@"; do
        print-subports "$p" && success=1
    done

    if [ $success -eq 0 ]; then
        errmsg "None of the specified ports were found in the port index."
        return 1
    fi
}
