#!/bin/bash

# Note:
# This script is sourced by the mpbb wrapper script.
# Do not execute this directly!


install-dependencies-help() {
    echo "Build and install all dependencies of port --port."
}

install-dependencies() {
    local dependencies

    if [ -z "${option_port}" ]; then
        errmsg "--port is required"
        return 1
    fi

    # calculate list of dependencies in-order
    dependencies=$("${option_prefix}/bin/port-tclsh" "${thisdir}/tools/dependencies.tcl" "${option_port}")
    if [ $? -ne 0 ]; then
        echo "Calculating dependencies for '${option_port}' failed, aborting." >&2
        return 1
    fi

    if [ -z "$dependencies" ]; then
        echo "'${option_port}' has no dependencies, continuing." >&2
        return 0
    fi

    echo "Installing dependencies:"
    echo "$dependencies" | sed -E 's/^/ - /'

    echo "$dependencies" | while read dependency; do
        # Split portname +variant1+variant2 into portname and variants, where
        # the variants are optional.
        depname=${dependency%% *}
        depvariants=${dependency:${#depname}+1}

        echo "----> Installing dependency '${depname}', variants: '${depvariants}'"
        if ! "${option_prefix}/bin/port" -d install --unrequested "$depname" $depvariants; then
            echo "Build of dependency '${depname}' failed, aborting." >&2
            return 1
        fi
    done
}
