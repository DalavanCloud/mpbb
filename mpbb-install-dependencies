#!/bin/bash

# Note:
# This script is sourced by the mpbb wrapper script.
# Do not execute this directly!


install-dependencies-help() {
    echo "Build and install all dependencies of port --port."
}

get-maintainers() {
    # $option_prefix is set in mpbb
    # shellcheck disable=SC2154
    "${option_prefix}/bin/port" info --index --maintainers --line "$@" | tr ',' '\n' | sort | uniq | tr '\n' ',' | \
        awk '{gsub(/(open|no)maintainer(@macports.org)?,/, ""); print}' | \
        tr '$' '\n' | sed 's/,$//' | tr '@' ';'
}

install-dependencies() {
    local dependencies
    local dependencies_count
    local dependencies_counter
    # $option_logdir is set in mpbb
    # shellcheck disable=SC2154
    local log_status_dependencies="${option_logdir}/dependencies-progress.txt"
    local log_subports_progress="${option_logdir}/ports-progress.txt"

    if [ -z "${option_port:-}" ]; then
        errmsg "--port is required"
        return 1
    fi

    # prepare the log file and make sure to start with an empty one
    mkdir -p "${option_logdir}"
    > "$log_status_dependencies"

    # calculate list of dependencies in-order
    # $option_prefix and $thisdir are set in mpbb
    # shellcheck disable=SC2154
    dependencies=$("${option_prefix}/bin/port-tclsh" "${thisdir}/tools/dependencies.tcl" "${option_port}" "${option_variants}")
    if [ $? -ne 0 ]; then
        echo "Calculating dependencies for '${option_port}' failed, aborting." >&2
        echo "Building '${option_port}' ... [ERROR] (failed to calculate dependencies) maintainers: $(get-maintainers "${option_port}")." >> "$log_subports_progress"
        return 1
    fi

    if [ -z "$dependencies" ]; then
        echo "'${option_port}' has no dependencies, continuing." >&2
        return 0
    fi

    dependencies_count=$(echo "$dependencies" | wc -l | sed 's/ *//g')
    dependencies_counter=1

    echo "Installing $dependencies_count dependencies of $option_port:" | tee -a "$log_status_dependencies"
    echo "$dependencies" | sed -E 's/^/ - /' | tee -a "$log_status_dependencies"
    echo >> "$log_status_dependencies"

    echo "$dependencies" | while read -r dependency; do
        # Split portname +variant1+variant2 into portname and variants, where
        # the variants are optional.
        depname=${dependency%% *}
        depvariants=${dependency:${#depname}+1}

        text="Installing dependency ($dependencies_counter of $dependencies_count) '${depname}' with variants '${depvariants}'"
        echo "----> ${text}"
        echo -n "${text} ... " >> "$log_status_dependencies"
        # $depvariants isn't quoted on purpose
        # shellcheck disable=SC2086
        if ! "${option_prefix}/bin/port" -d install --unrequested "$depname" $depvariants ${option_variants}; then
            echo "Build of dependency '${depname}' failed, aborting." >&2
            echo "[FAIL]" >> "$log_status_dependencies"
            echo "Building '${option_port}' ... [ERROR] (failed to install dependency '${depname}') maintainers: $(get-maintainers "${option_port}" "${depname}")." >> "$log_subports_progress"
            return 1
        else
            echo "[OK]" >> "$log_status_dependencies"
            dependencies_counter=$((dependencies_counter + 1))
        fi
    done
}

