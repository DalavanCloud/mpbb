#!/bin/bash

# Note:
# This script is sourced by the mpbb wrapper script.
# Do not execute this directly!


checkout-help() {
    cat <<EOF
Update or checkout a working copy of the ports tree from --svn-url to specific
SVN revision (--svn-revision), update or create the PortIndex and configure
the MacPorts installation to use this ports tree.
EOF
}

checkout() {
    # $option_workdir is set in mpbb, which sources this script
    # shellcheck disable=SC2154
    dports_svn=${option_workdir}/dports
    tools_svn=${option_workdir}/tools
    # $option_svn is set in mpbb
    # shellcheck disable=SC2154
    svn=${option_svn}
    # $option_svn_url and $option_svn_revision are set in mpbb
    # shellcheck disable=SC2154
    svn_url=${option_svn_url}
    # shellcheck disable=SC2154
    svn_rev=${option_svn_revision}

    if [[ -d "${tools_svn}/.svn" ]] ; then
        echo "Update macports tools from svn..."
        if [[ -e "${tools_svn}/.svn/lock" ]]; then
            "$svn" --non-interactive cleanup "${tools_svn}" || return $?
        fi
        "$svn" update --non-interactive \
            -r HEAD \
            "${tools_svn}" || return $?
    else
        echo "Checking out macports tools from svn..."
        mkdir -p "${option_workdir}"
        "$svn" checkout --non-interactive \
            -r HEAD "${svn_url}/base/portmgr/jobs" \
            "${tools_svn}" || return $?
    fi

    if [[ -d "${dports_svn}/.svn" ]] ; then
        echo "Update macports from svn..."
        # TODO: add switching of SVN server
        if [[ -e "${dports_svn}/.svn/lock" ]]; then
            "$svn" --non-interactive cleanup "${dports_svn}" || return $?
        fi
        "$svn" update --non-interactive \
            -r "${svn_rev}" \
            "${dports_svn}" || return $?
    else
        echo "Checking out macports from svn..."
        mkdir -p "${option_workdir}"
        "$svn" checkout --non-interactive \
            -r "${svn_rev}" "${svn_url}/dports" \
            "${dports_svn}" || return $?
    fi

    # $option_prefix is set in mpbb
    # shellcheck disable=SC2154
    (cd "${dports_svn}" && "${option_prefix}/bin/portindex") || return $?

    cat > "${option_workdir}/macports.conf" <<EOF || return $?
# Automatically overwritten by mpbb-checkout
# Do not edit !!!
sources_conf ${option_workdir}/sources.conf
host_blacklist aarnet.au.distfiles.macports.org aarnet.au.packages.macports.org cjj.kr.distfiles.macports.org cjj.kr.packages.macports.org fco.it.distfiles.macports.org fco.it.packages.macports.org her.gr.distfiles.macports.org her.gr.packages.macports.org jnb.za.distfiles.macports.org jnb.za.packages.macports.org jog.id.distfiles.macports.org jog.id.packages.macports.org lil.fr.distfiles.macports.org lil.fr.packages.macports.org mse.uk.distfiles.macports.org mse.uk.packages.macports.org nou.nc.distfiles.macports.org nou.nc.packages.macports.org nue.de.distfiles.macports.org nue.de.packages.macports.org osl.no.distfiles.macports.org osl.no.packages.macports.org sea.us.distfiles.macports.org sea.us.packages.macports.org ykf.ca.distfiles.macports.org ykf.ca.packages.macports.org
EOF

    cat > "${option_workdir}/sources.conf" <<EOF || return $?
# Automatically overwritten by mpbb-checkout
# Do not edit !!!
file://${dports_svn} [default]
EOF

}
