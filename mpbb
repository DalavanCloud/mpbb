#!/bin/bash
# -*- coding: utf-8; mode: sh; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=sh:et:sw=4:ts=4:sts=4

# Abort on undefined variables.
set -u

# shellcheck disable=SC2154
# Don't inherit any option variables from the calling environment.
unset "${!option_@}"

# Print $0 and arguments to standard error.
# Unset IFS to ensure "$*" uses spaces as separators.
msg() (unset IFS; printf >&2 '%s: %s\n' "$0" "$*")
err() { msg error: "$@"; }
warn() { msg warning: "$@"; }

usage() {
    cols=$(tput cols) || cols=80

    fmt -w $(( cols - 8 )) >&2 <<-EOF
Usage: $0 COMMAND [OPTION...]

mpbb, a script to help build MacPorts ports in a continous integration
environment.

OPTIONS

 --archive-site URL
   Base URL of the packages archive to check whether an archive was not
   published yet. Default is "https://packages.macports.org".

 --help
   Print this usage message.

 --prefix PREFIX
   The prefix of the MacPorts installation that will build the ports. Defaults
   to "/opt/local".

 --svn BINARY
   Absolute path to the svn binary that you want to use for SVN operations. The
   default is to find svn in your path.

 --svn-url SVNURL
   URL to a Subversion repository in a format accepted by Subversion. The
   referenced folder must contain a dports and a base folder. The default is
   "https://svn.macports.org/repository/macports/trunk".

 --svn-revision REVISION
   Revision number in the specified Subversion repository to checkout. Defaults
   to "HEAD".

 --staging-dir DIR
   Directory where new distributable archives should be copied for deployment
   on the archive server. Defaults to the 'archive-staging' subfolder in the
   current directory.

 --work-dir WORKDIR
   A scratch area that mpbb will use to put temporary files, ideally kept
   between builds. Your MacPorts installation in --prefix needs to be able to
   access this location. Defaults to your current directory, or
   /tmp/mp-buildbot if \$PWD isn't set.
EOF

    printf >&2 "\nCOMMANDS\n"
    for command in "${commands[@]}"; do
        printf >&2 " %s\n" "$command"
        printf "   %s\n\n" "$("${command}-help" | tr '\n' ' ')" | fmt -w $(( cols - 8 )) >&2
    done

    exit 2
}

## Load the mpbb-$command scripts and source them to load the actual implementations and help messages of available commands
commands=()
thisdir=$(cd "$(dirname "$0")" && pwd)
for cmdfile in "$thisdir/mpbb-"*; do
    # Unfortunately ShellCheck does not currently support following multiple
    # files, so we'll just disable the warning.
    # shellcheck disable=SC1090
    . "$cmdfile"
    commands+=(${cmdfile#$thisdir/mpbb-})
done

## The first argument should be the subcommand
if [[ $# -lt 1 ]]; then
    err "No command specified"
    usage
fi

command=$1
shift
if [ ! -f "$thisdir/mpbb-$command" ]; then
    if [ "$command" != "--help" ]; then
        err "Unknown command $command"
    fi
    usage
fi

## Flag Parsing
while [[ $# -gt 0 ]]; do
    key=$1

    case "$key" in
        --*)
            # Shellcheck doesn't see the invocations in the sourced
            # scripts, so we'll have to disable a number of false
            # positives here.

            # shellcheck disable=SC2034
            case "$key" in
                --archive-site)
                    option_archive_site=$2
                    shift
                    ;;
                --help)
                    option_help=1
                    ;;
                --port)
                    # Deprecated and will be removed in the near future.
                    option_port=$2
                    shift
                    ;;
                --prefix)
                    option_prefix=$2
                    shift
                    ;;
                --staging-dir)
                    option_staging_dir=$2
                    shift
                    ;;
                --svn)
                    option_svn=$2
                    shift
                    ;;
                --svn-url)
                    option_svn_url=$2
                    shift
                    ;;
                --svn-revision)
                    option_svn_revision=$2
                    shift
                    ;;
                --work-dir)
                    option_work_dir=$2
                    shift
                    ;;
                --)
                    shift
                    break
                    ;;
                *)
                    err "Unknown option: ${key}"
                    option_help=1
                    break
                    ;;
            esac

            shift
            ;;
        *)
            break
            ;;
    esac
done

# Use sensible defaults for options that weren't set on the command line.
: "${option_port=}"
: "${option_prefix=/opt/local}"
: "${option_work_dir=${PWD:-/tmp/mp-buildbot}}"
: "${option_archive_site=https://packages.macports.org}"
: "${option_staging_dir=${option_work_dir}/archive-staging}"
: "${option_svn=$(which svn)}"
: "${option_svn_revision=HEAD}"
: "${option_svn_url=https://svn.macports.org/repository/macports/trunk}"
: "${option_help=0}"

# shellcheck disable=SC2034 disable=SC2154
# Not really options, but pretend they are because they're global.
option_log_dir=${option_work_dir}/logs

## If subcommand help is requested, print that
if [[ $option_help -eq 1 ]]; then
    usage
fi

## Otherwise, run the command and deal with errors
PORTSRC=${option_work_dir}/macports.conf "$command" "$@"
readonly rc=$?
case $rc in
    0)
        ;;
    *)
        err "\`$command' failed to run successfully"
        ;;
esac
exit $rc
